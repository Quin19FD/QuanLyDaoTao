
<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.w3.org/1999/xhtml">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản Lý Danh Mục Học Phần - Khoa CNTT</title>
    <style>
        * {
            font-size: 20px;
        }

        body {
            font-family: Arial, sans-serif;
            background-color: #f5f5f5;
            margin: 0;
            padding: 20px;
        }

        .container {
            max-width: 90%;
            margin: 0 auto;
            background-color: #fff;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }

        h1 {
            font-size: 30px;
            color: #ff8c66;
            text-align: center;
            margin-bottom: 20px;
        }

        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .controls input,
        .controls select,
        .controls button {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        th,
        td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        th {
            background-color: #ff8c66;
            color: white;
        }

        td {
            background-color: #fff7f2;
        }

        tr:hover {
            background-color: #ffe6d5;
            cursor: pointer;
        }

        button {
            padding: 8px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 0 5px;
        }

        .add-btn, .filter-btn {
            background-color: #ff8c66;
            color: white;
        }

        .delete-btn {
            background-color: #F44336;
            color: white;
        }

        .edit-btn {
            background-color: #FFC107;
            color: white;
        }

        .view-btn {
            background-color: #2196F3;
            color: white;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            overflow: auto;
        }

        .modal-content {
            background-color: #fff;
            margin: 5% auto;
            padding: 0;
            border-radius: 12px;
            width: 100%;
            max-width: 1000px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            background-color: #ff8c66;
            color: white;
            padding: 15px 20px;
            border-top-left-radius: 12px;
            border-top-right-radius: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            margin: 0;
            font-size: 1.5em;
        }

        .close {
            color: white;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.3s ease;
        }

        .close:hover {
            color: #ffe6d5;
        }

        .modal-body {
            padding: 20px;
            background-color: #fff7f2;
            border-bottom-left-radius: 12px;
            border-bottom-right-radius: 12px;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid #ffe6d5;
        }

        .info-row:last-child {
            border-bottom: none;
        }

        .info-row label {
            font-weight: bold;
            color: #ff8c66;
            flex: 1;
        }

        .info-row span,
        .info-row select {
            flex: 2;
            color: #333;
        }

        .form-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #ffe6d5;
        }

        .form-row:last-child {
            border-bottom: none;
        }

        .form-row label {
            font-weight: bold;
            color: #ff8c66;
            flex: 1;
        }

        .form-row input,
        .form-row select,
        .form-row .static-field {
            flex: 2;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 20px;
            transition: border-color 0.3s ease;
        }

        .form-row .static-field {
            background-color: #f0f0f0;
            border: none;
            padding: 8px;
            color: #666;
        }

        .form-row input:focus,
        .form-row select:focus {
            border-color: #ff8c66;
            outline: none;
        }

        .dept-select {
            height: 80px;
            background-color: #fff;
        }

        .form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            padding-top: 20px;
        }

        .save-btn {
            background-color: #4CAF50;
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            transition: background-color 0.3s ease;
        }

        .save-btn:hover {
            background-color: #45a049;
        }

        .cancel-btn {
            background-color: #ccc;
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            transition: background-color 0.3s ease;
        }

        .cancel-btn:hover {
            background-color: #b3b3b3;
        }

        .back-home-btn {
            position: fixed;
            top: 20px;
            left: 20px;
            padding: 10px 20px;
            background-color: #ff8c66;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .back-home-btn:hover {
            background-color: #e67e5a;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }

        .back-home-btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 3px rgba(0,0,0,0.2);
        }

        .back-home-btn i {
            font-size: 18px;
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
</head>

<body>
<a th:href="@{/home}" class="back-home-btn">
    <i class="fas fa-home"></i>
    Trang Chủ
</a>
<div class="container">
    <h1>QUẢN LÝ DANH MỤC HỌC PHẦN - KHOA CNTT</h1>
    <div class="controls">
        <button class="add-btn" th:if="${isAdmin}" onclick="openAddModal()">+ Thêm Học Phần</button>
        <input type="text" id="searchInput" placeholder="Tìm kiếm theo mã hoặc tên...">
        <button class="filter-btn" onclick="filterCourses()">Lọc</button>
    </div>

    <table id="courseTable">
        <thead>
        <tr>
            <th>Mã HP</th>
            <th>Tên Học phần</th>
            <th>Mã CTĐT</th>
            <th>Số tín chỉ</th>
            <th>Lý thuyết</th>
            <th>Thực hành</th>
            <th>Thực tập</th>
            <th>Hệ số</th>
            <th>Thao Tác</th>
        </tr>
        </thead>
        <tbody id="courseTableBody"></tbody>
    </table>
</div>

<div id="viewModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Chi Tiết Học Phần</h2>
            <span class="close" onclick="closeModal('viewModal')">×</span>
        </div>
        <div class="modal-body">
            <div class="info-row">
                <label>Mã Học Phần:</label>
                <span id="viewCourseId"></span>
            </div>
            <div class="info-row">
                <label>Tên Học Phần:</label>
                <span id="viewCourseName"></span>
            </div>
            <div class="info-row">
                <label>Mã CTĐT:</label>
                <span id="viewTrainingProgram"></span>
            </div>
            <div class="info-row">
                <label>Chuyên ngành:</label>
                <span id="viewSpecialization"></span>
            </div>
            <div class="info-row">
                <label>Số Tín Chỉ Lý Thuyết:</label>
                <span id="viewTheoryCredits"></span>
            </div>
            <div class="info-row">
                <label>Số Tín Chỉ Thực Hành:</label>
                <span id="viewPracticeCredits"></span>
            </div>
            <div class="info-row">
                <label>Số Tín Chỉ Thực Tập:</label>
                <span id="viewInternshipCredits"></span>
            </div>
            <div class="info-row">
                <label>Hệ Số:</label>
                <span id="viewCoefficient"></span>
            </div>
        </div>
    </div>
</div>

<div id="addModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Thêm Học Phần Mới</h2>
            <span class="close" onclick="closeModal('addModal')">×</span>
        </div>
        <div class="modal-body">
            <form id="addForm">
                <div class="form-row">
                    <label for="newCourseId">Mã Học Phần:</label>
                    <input type="text" id="newCourseId" required>
                </div>
                <div class="form-row">
                    <label for="trainingProgram">Mã CTĐT:</label>
                    <select id="trainingProgram" required>

                    </select>
                </div>
                <div class="form-row">
                    <label for="courseName">Tên Học Phần:</label>
                    <input type="text" id="courseName" required>
                </div>
                <div class="form-row">
                    <label for="groupSelect">Nhóm Kiến Thức:</label>
                    <select id="groupSelect" disabled></select>
                </div>
                <div class="form-row" id="addSpecializationRow" style="display: none;">
                    <label for="specializationInput">Chuyên ngành:</label>
                    <input type="text" id="specializationInput">
                </div>
                <div class="form-row">
                    <label for="theoryCredits">Số Tín Chỉ Lý Thuyết:</label>
                    <input type="number" id="theoryCredits" min="0" required>
                </div>
                <div class="form-row">
                    <label for="practiceCredits">Số Tín Chỉ Thực Hành:</label>
                    <input type="number" id="practiceCredits" min="0" required>
                </div>
                <div class="form-row">
                    <label for="internshipCredits">Số Tín Chỉ Thực Tập:</label>
                    <input type="number" id="internshipCredits" min="0" required>
                </div>
                <div class="form-row">
                    <label for="coefficient">Hệ Số:</label>
                    <input type="number" id="coefficient" min="1" step="0.1" required>
                </div>
                <div class="form-actions">
                    <button type="button" class="save-btn" onclick="">Thêm</button>
                    <button type="button" class="cancel-btn" onclick="closeModal('addModal')">Hủy</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div id="editModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Sửa Học Phần</h2>
            <span class="close" onclick="closeModal('editModal')">×</span>
        </div>
        <div class="modal-body">
            <form id="editForm">
                <div class="form-row">
                    <label for="editCourseId">Mã Học Phần:</label>

                    <span id="editCourseId" class="static-field" disable></span>
                </div>
                <div class="form-row">
                    <label for="editTrainingProgram">Mã CTĐT:</label>
                    <span id="editTrainingProgram" class="static-field" disable></span>
                </div>
                <div class="form-row">
                    <label for="editCourseName">Tên Học Phần:</label>
                    <input type="text" id="editCourseName" required>
                </div>


                <div class="form-row" id="editSpecializationRow" style="display: none;">
                    <label for="editSpecializationInput">Chuyên ngành:</label>
                    <input type="text" id="editSpecializationInput">
                </div>
                <div class="form-row">
                    <label for="editTheoryCredits">Số Tín Chỉ Lý Thuyết:</label>
                    <input type="number" id="editTheoryCredits" min="0" required>
                </div>
                <div class="form-row">
                    <label for="editPracticeCredits">Số Tín Chỉ Thực Hành:</label>
                    <input type="number" id="editPracticeCredits" min="0" required>
                </div>
                <div class="form-row">
                    <label for="editInternshipCredits">Số Tín Chỉ Thực Tập:</label>
                    <input type="number" id="editInternshipCredits" min="0" required>
                </div>

                <div class="form-row">
                    <label for="editCoefficient">Hệ Số:</label>
                    <input type="number" id="editCoefficient" min="1" step="0.1" required>
                </div>
                <div class="form-actions">
                    <button type="button" class="save-btn" onclick="saveEdit()">Lưu</button>
                    <button type="button" class="cancel-btn" onclick="closeModal('editModal')">Hủy</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div id="deleteModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Xác Nhận Xóa</h2>
            <span class="close" onclick="closeModal('deleteModal')">×</span>
        </div>
        <div class="modal-body">
            <p>Bạn có chắc chắn muốn xóa học phần <span id="deleteCourseName"></span> không? Thông tin sẽ bị xóa vĩnh viễn.</p>
            <div class="form-actions">
                <button class="delete-btn" onclick="confirmDelete()">Xóa</button>
                <button class="cancel-btn" onclick="closeModal('deleteModal')">Hủy</button>
            </div>
        </div>
    </div>
</div>

<script th:inline="javascript">
    const isAdmin = /*[[${isAdmin}]]*/ false;
    const isTeacher = /*[[${isTeacher}]]*/ false;
    const isUser = /*[[${isUser}]]*/ false;
    const userRole = /*[[${userRole}]]*/ '';

    function checkPermission() {
        const adminButtons = document.querySelectorAll('.add-btn, .edit-btn, .delete-btn');
        adminButtons.forEach(button => {
            button.style.display = isAdmin ? 'inline-block' : 'none';
        });

        if (!isAdmin) {
            const addModal = document.getElementById('addModal');
            const editModal = document.getElementById('editModal');
            const deleteModal = document.getElementById('deleteModal');
            if (addModal) addModal.style.display = 'none';
            if (editModal) editModal.style.display = 'none';
            if (deleteModal) deleteModal.style.display = 'none';
        }
    }

    async function getAllCTHocPhan() {
        try {
            const response = await fetch('http://localhost:8080/api/cthocphan');
            if (!response.ok) throw new Error('Không thể lấy dữ liệu');
            const data = await response.json();
            console.log(data);
            loadCTHocPhan(data);
        } catch (error) {
            console.error('Lỗi khi lấy danh sách:', error);
        }
    }

    function loadCTHocPhan(data) {
        const tableBody = document.getElementById("courseTableBody");
        tableBody.innerHTML = "";

        data.forEach((course, index) => {
            const row = document.createElement("tr");

            row.innerHTML = `
                <td>${course.maHocPhan.maHocPhan}</td>
                <td>${course.maHocPhan.tenHocPhan}</td>
                <td>${course.maHocPhan.maDaoTao.maCTDT}</td>
                <td>${course.maHocPhan.soTinChi}</td>
                <td>${course.lyThuyet}</td>
                <td>${course.thucHanh}</td>
                <td>${course.thucTap}</td>
                <td>${course.maHocPhan.heSo}</td>
                <td>
                    <button class="view-btn">Xem Chi Tiết</button>
                    ${isAdmin ? `
                        <button class="edit-btn">Sửa</button>
                        <button class="delete-btn">Xóa</button>
                    ` : ''}
                </td>
            `;

            // Thêm event listener thay vì dùng onclick trong HTML
            row.querySelector(".view-btn").addEventListener("click", () => viewDetails(course));
            if (isAdmin) {
                row.querySelector(".edit-btn").addEventListener("click", () => editCourse(course));
                row.querySelector(".delete-btn").addEventListener("click", () => openDeleteModal(course));
            }

            tableBody.appendChild(row);
        });
    }


  // Gọi danh sách chương trình đào tạo đã có chương trình khung
async function fetchCTDTDaCoKhung() {
    try {
        const response = await fetch('/api/CTDT_View/da-co-khung');
        if (response.status === 204) {
            console.log("Không có dữ liệu CTĐT đã có khung.");
            return;
        } else if (!response.ok) {
            throw new Error(`Lỗi khi gọi API /da-co-khung: ${response.statusText}`);
        }

        const programs = await response.json();
        console.log("Danh sách CTĐT đã có khung (programs):", programs);

        const component2 = document.getElementById('trainingProgram');

        let html = '<option value="">-- Chọn chương trình đào tạo --</option>';
        for (let i = 0; i < programs.length; i++) {
            html += `<option value="${programs[i].maCTDT}">${programs[i].tenCTDT}-(${programs[i].maCTDT})</option>`;
        }

        component2.innerHTML = html;

    } catch (error) {
        console.error("Lỗi fetchCTDTDaCoKhung:", error);
    }
}


    function closeModal(modalId) {
        document.getElementById(modalId).style.display = "none";
    }

    function openAddModal() {
        document.getElementById("addModal").style.display = "block";
    }

function viewDetails(course) {
    const viewCourseId = document.getElementById('viewCourseId');
    const viewCourseName = document.getElementById('viewCourseName');
    const viewTrainingProgram = document.getElementById('viewTrainingProgram');
    const viewSpecialization = document.getElementById('viewSpecialization');
    const viewTheoryCredits = document.getElementById('viewTheoryCredits');
    const viewPracticeCredits = document.getElementById('viewPracticeCredits');
    const viewInternshipCredits = document.getElementById('viewInternshipCredits');
    const viewCoefficient = document.getElementById('viewCoefficient');

    // Kiểm tra dữ liệu trước khi gán
    viewCourseId.innerHTML = course?.maHocPhan?.maHocPhan || 'N/A';
    viewCourseName.innerHTML = course?.maHocPhan?.tenHocPhan || 'N/A';
    viewTrainingProgram.innerHTML = course?.maHocPhan?.maDaoTao ?
        `${course.maHocPhan.maDaoTao.maCTDT} - ${course.maHocPhan.maDaoTao.tenCTDT}` : 'N/A';
    viewSpecialization.innerHTML = course?.maHocPhan?.maChuyenNghanh || 'Không có';
    viewTheoryCredits.innerHTML = course?.lyThuyet ?? '0';
    viewPracticeCredits.innerHTML = course?.thucHanh ?? '0';
    viewInternshipCredits.innerHTML = course?.thucTap ?? '0';
    viewCoefficient.innerHTML = course?.maHocPhan?.heSo ?? 'N/A';

    document.getElementById('viewModal').style.display = 'block';
}gi

    function editCourse(index) {
        document.getElementById("editModal").style.display = "block";
    }

      function openDeleteModal(index) {
        document.getElementById("deleteModal").style.display = "block";
    }


    window.onload = function() {
        checkPermission();
        getAllCTHocPhan();
         fetchCTDTDaCoKhung();
    }
</script>


</body>

</html>