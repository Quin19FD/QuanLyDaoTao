<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.w3.org/1999/xhtml">
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qu·∫£n L√Ω Ch∆∞∆°ng Tr√¨nh Khung CNTT</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

        body {
            font-family: 'Inter', sans-serif;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 10;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 1.5rem;
            border-radius: 0.75rem;
            width: 100%;
            max-width: 900px;
        }

        .program-select-table {
            max-height: 300px;
            overflow-y: auto;
        }

        .btn-orange {
            background: linear-gradient(to right, #f97316, #fb923c);
            color: white;
            transition: all 0.3s ease;
        }

        .btn-orange:hover {
            background: linear-gradient(to right, #ea580c, #f97316);
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(249, 115, 22, 0.3);
        }

        .btn-green {
            background: linear-gradient(to right, #4CAF50, #66BB6A);
            color: white;
            transition: all 0.3s ease;
        }

        .btn-green:hover {
            background: linear-gradient(to right, #388E3C, #4CAF50);
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);
        }

        .btn-yellow {
            background: linear-gradient(to right, #FFC107, #FFCA28);
            color: white;
            transition: all 0.3s ease;
        }

        .btn-yellow:hover {
            background: linear-gradient(to right, #FFA000, #FFC107);
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(255, 193, 7, 0.3);
        }

        .btn-red {
            background: linear-gradient(to right, #F44336, #EF5350);
            color: white;
            transition: all 0.3s ease;
        }

        .btn-red:hover {
            background: linear-gradient(to right, #D32F2F, #F44336);
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(244, 67, 54, 0.3);
        }

        .btn-gray {
            background: linear-gradient(to right, #B0BEC5, #CFD8DC);
            color: white;
            transition: all 0.3s ease;
        }

        .btn-gray:hover {
            background: linear-gradient(to right, #90A4AE, #B0BEC5);
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(176, 190, 197, 0.3);
        }

        table tr:nth-child(even) {
            background-color: #fef5e7;
        }

        table tr:hover {
            background-color: #ffedd5;
            transition: background-color 0.2s ease;
        }

        input:focus,
        select:focus {
            border-color: #f97316;
            box-shadow: 0 0 0 3px rgba(249, 115, 22, 0.1);
        }

        /* Th√™m style cho n√∫t tr·ªü v·ªÅ trang ch·ªß */
        .back-home-btn {
            position: fixed;
            top: 20px;
            left: 20px;
            padding: 10px 20px;
            background: linear-gradient(to right, #f97316, #fb923c);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            text-decoration: none;
        }

        .back-home-btn:hover {
            background: linear-gradient(to right, #ea580c, #f97316);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }

        .back-home-btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 3px rgba(0,0,0,0.2);
        }

        .back-home-btn i {
            font-size: 18px;
        }
    </style>
    <!-- Th√™m Font Awesome ƒë·ªÉ s·ª≠ d·ª•ng icon -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
</head>

<body class="bg-gray-100 min-h-screen p-6">
<!-- Th√™m n√∫t tr·ªü v·ªÅ trang ch·ªß -->
<a th:href="@{/home}" class="back-home-btn">
    <i class="fas fa-home"></i>
    Trang Ch·ªß
</a>
<div class="container max-w-full mx-auto bg-white p-6 rounded-lg shadow-lg">
    <h1 class="text-3xl font-bold text-center text-orange-600 mb-4">
        QU·∫¢N L√ù CH∆Ø∆†NG TR√åNH KHUNG
        <span th:if="${isAdmin}" class="text-sm">(ADMIN)</span>
    </h1>
    <button class="btn-orange px-6 py-3 rounded-lg mb-6" th:if="${isAdmin}" onclick="openSelectProgramModal()">
        + Th√™m CTKhung M·ªõi
    </button>
    <div class="overflow-x-auto">
        <table class="w-full border-collapse">
            <thead>
            <tr class="bg-orange-500 text-white">
                <th class="p-4 text-left">M√É CTDT</th>
                <th class="p-4 text-left">T√äN CTDT</th>
                <th class="p-4 text-left">THAO T√ÅC</th>
            </tr>
            </thead>
            <tbody id="programTableBody"></tbody>
        </table>
    </div>
</div>

<!-- Modal for Selecting Program -->
<div id="selectProgramModal" class="modal">
    <div class="modal-content">
            <span class="close text-2xl font-bold text-gray-500 float-right cursor-pointer"
                  onclick="closeModal('selectProgramModal')">√ó</span>
        <h2 class="text-2xl font-semibold text-gray-700 mb-4">Ch·ªçn Ch∆∞∆°ng Tr√¨nh ƒê√†o T·∫°o</h2>
        <div class="program-select-table">
            <table class="w-full border-collapse">
                <thead>
                <tr class="bg-orange-500 text-white">
                    <th class="p-3 text-left">M√£ CTDT</th>
                    <th class="p-3 text-left">T√™n CTDT</th>
                    <th class="p-3 text-left">H√†nh ƒë·ªông</th>
                </tr>
                </thead>
                <tbody id="programSelectTableBody"></tbody>
            </table>
        </div>
    </div>
</div>

<!-- Modal for Viewing Details -->
<div id="viewModal" class="modal">
    <div class="modal-content">
        <span class="close text-2xl font-bold text-gray-500 float-right cursor-pointer"
              onclick="closeModal('viewModal')">√ó</span>
        <h2 class="text-2xl font-semibold text-gray-700 mb-4">Chi Ti·∫øt Ch∆∞∆°ng Tr√¨nh Khung</h2>
        <table class="w-full border-collapse">
            <thead>
            <tr class="bg-orange-500 text-black">
                <th class="p-3 text-left" colspan="3">C√°c Kh·ªëi Ki·∫øn Th·ª©c</th>
            </tr>
            <tr class="bg-orange-500 text-black">
                <th class="p-3 text-left"></th>
                <th class="p-3 text-left">S·ªë t√≠n ch·ªâ B·∫Øt bu·ªôc</th>
                <th class="p-3 text-left">S·ªë t√≠n ch·ªâ T·ª± ch·ªçn</th>
            </tr>
            </thead>
            <tbody id="detailTableBody">
            <tr class="hover:bg-orange-100">
                <td class="p-3" colspan="3">Kh·ªëi ki·∫øn th·ª©c gi√°o d·ª•c ƒë·∫°i c∆∞∆°ng</td>
            </tr>
            <tr>
                <td class="p-3">Ki·∫øn th·ª©c gi√°o d·ª•c th·ªÉ ch·∫•t v√† qu·ªëc ph√≤ng an ninh</td>
                <td class="p-3"><input type="number" min="1" value="0" class="p-2 border border-gray-300 rounded-lg w-full"></td>
                <td class="p-3"><input type="number" min="1" value="0" class="p-2 border border-gray-300 rounded-lg w-full"></td>
            </tr>
            <tr>
                <td class="p-3">Ki·∫øn th·ª©c ngo·∫°i ng·ªØ</td>
                <td class="p-3"><input type="number" min="1" value="0" class="p-2 border border-gray-300 rounded-lg w-full"></td>
                <td class="p-3"><input type="number" min="1" value="0" class="p-2 border border-gray-300 rounded-lg w-full"></td>
            </tr>
            <tr>
                <td class="p-3">Ki·∫øn th·ª©c l√Ω lu·∫≠n ch√≠nh tr·ªã</td>
                <td class="p-3"><input type="number" min="1" value="0" class="p-2 border border-gray-300 rounded-lg w-full"></td>
                <td class="p-3"><input type="number" min="1" value="0" class="p-2 border border-gray-300 rounded-lg w-full"></td>
            </tr>
            <tr>
                <td class="p-3">Ki·∫øn th·ª©c gi√°o d·ª•c ƒë·∫°i c∆∞∆°ng kh√°c</td>
                <td class="p-3"><input type="number" min="1" value="0" class="p-2 border border-gray-300 rounded-lg w-full"></td>
                <td class="p-3"><input type="number" min="1" value="0" class="p-2 border border-gray-300 rounded-lg w-full"></td>
            </tr>
            <tr class="hover:bg-orange-100">
                <td class="p-3" colspan="3">Kh·ªëi ki·∫øn th·ª©c gi√°o d·ª•c chuy√™n nghi·ªáp</td>
            </tr>
            <tr>
                <td class="p-3">Ki·∫øn th·ª©c c∆° s·ªü ng√†nh</td>
                <td class="p-3"><input type="number" min="1" value="0" class="p-2 border border-gray-300 rounded-lg w-full"></td>
                <td class="p-3"><input type="number" min="1" value="0" class="p-2 border border-gray-300 rounded-lg w-full"></td>
            </tr>
            <tr>
                <td class="p-3">Ki·∫øn th·ª©c ng√†nh</td>
                <td class="p-3"><input type="number" min="1" value="0" class="p-2 border border-gray-300 rounded-lg w-full"></td>
                <td class="p-3"><input type="number" min="1" value="0" class="p-2 border border-gray-300 rounded-lg w-full"></td>
            </tr>
            <tr>
                <td class="p-3">Ki·∫øn th·ª©c chuy√™n ng√†nh</td>
                <td class="p-3"><input type="number" min="1" value="0" class="p-2 border border-gray-300 rounded-lg w-full"></td>
                <td class="p-3"><input type="number" min="1" value="0" class="p-2 border border-gray-300 rounded-lg w-full"></td>
            </tr>
            </tbody>
        </table>
    </div>
</div>


<!-- Modal for Editing -->
<div id="editModal" class="modal">
    <div class="modal-content">
            <span class="close text-2xl font-bold text-gray-500 float-right cursor-pointer"
                  onclick="closeModal('editModal')">√ó</span>
        <h2 class="text-2xl font-semibold text-gray-700 mb-4">S·ª≠a Ch∆∞∆°ng Tr√¨nh Khung</h2>
        <table class="w-full border-collapse">
            <thead>
            <tr class="bg-orange-500 text-black">
                <th class="p-3 text-left" colspan="3">C√°c Kh·ªëi Ki·∫øn Th·ª©c</th>
            </tr>
            <tr class="bg-orange-500 text-black">
                <th class="p-3 text-left"></th>
                <th class="p-3 text-left">S·ªë t√≠n ch·ªâ B·∫Øt bu·ªôc</th>
                <th class="p-3 text-left">S·ªë t√≠n ch·ªâ T·ª± ch·ªçn</th>
            </tr>
            </thead>
            <tbody id="editTableBody">
            <tr class="hover:bg-orange-100">
                <td class="p-3" colspan="3">Kh·ªëi ki·∫øn th·ª©c gi√°o d·ª•c ƒë·∫°i c∆∞∆°ng</td>
            </tr>
            <tr>
                <td class="p-3">Ki·∫øn th·ª©c gi√°o d·ª•c th·ªÉ ch·∫•t v√† qu·ªëc ph√≤ng an ninh</td>
                <td class="p-3"><input type="number" min="1" value="0" class="p-2 border border-gray-300 rounded-lg w-full"></td>
                <td class="p-3"><input type="number" min="1" value="0" class="p-2 border border-gray-300 rounded-lg w-full"></td>
            </tr>
            <tr>
                <td class="p-3">Ki·∫øn th·ª©c ngo·∫°i ng·ªØ</td>
                <td class="p-3"><input type="number" min="1" value="0" class="p-2 border border-gray-300 rounded-lg w-full"></td>
                <td class="p-3"><input type="number" min="1" value="0" class="p-2 border border-gray-300 rounded-lg w-full"></td>
            </tr>
            <tr>
                <td class="p-3">Ki·∫øn th·ª©c l√Ω lu·∫≠n ch√≠nh tr·ªã</td>
                <td class="p-3"><input type="number" min="1" value="0" class="p-2 border border-gray-300 rounded-lg w-full"></td>
                <td class="p-3"><input type="number" min="1" value="0" class="p-2 border border-gray-300 rounded-lg w-full"></td>
            </tr>
            <tr>
                <td class="p-3">Ki·∫øn th·ª©c gi√°o d·ª•c ƒë·∫°i c∆∞∆°ng kh√°c</td>
                <td class="p-3"><input type="number" min="1" value="0" class="p-2 border border-gray-300 rounded-lg w-full"></td>
                <td class="p-3"><input type="number" min="1" value="0" class="p-2 border border-gray-300 rounded-lg w-full"></td>
            </tr>
            <tr class="hover:bg-orange-100">
                <td class="p-3" colspan="3">Kh·ªëi ki·∫øn th·ª©c gi√°o d·ª•c chuy√™n nghi·ªáp</td>
            </tr>
            <tr>
                <td class="p-3">Ki·∫øn th·ª©c c∆° s·ªü ng√†nh</td>
                <td class="p-3"><input type="number" min="1" value="0" class="p-2 border border-gray-300 rounded-lg w-full"></td>
                <td class="p-3"><input type="number" min="1" value="0" class="p-2 border border-gray-300 rounded-lg w-full"></td>
            </tr>
            <tr>
                <td class="p-3">Ki·∫øn th·ª©c ng√†nh</td>
                <td class="p-3"><input type="number" min="1" value="0" class="p-2 border border-gray-300 rounded-lg w-full"></td>
                <td class="p-3"><input type="number" min="1" value="0" class="p-2 border border-gray-300 rounded-lg w-full"></td>
            </tr>
            <tr>
                <td class="p-3">Ki·∫øn th·ª©c chuy√™n ng√†nh</td>
                <td class="p-3"><input type="number" min="1" value="0" class="p-2 border border-gray-300 rounded-lg w-full"></td>
                <td class="p-3"><input type="number" min="1" value="0" class="p-2 border border-gray-300 rounded-lg w-full"></td>
            </tr>
            </tbody>
        </table>
        <button class="btn-green px-6 py-3 rounded-lg mt-4" id="btnEdit">Ho√†n Th√†nh</button>
    </div>
</div>

<!-- Modal for Adding New Program -->
<div id="addModal" class="modal">
    <div class="modal-content">
            <span class="close text-2xl font-bold text-gray-500 float-right cursor-pointer"
                  onclick="closeModal('addModal')">√ó</span>
        <h2 class="text-2xl font-semibold text-gray-700 mb-4">Th√™m Ch∆∞∆°ng Tr√¨nh Khung M·ªõi</h2>
        <div id="selectedProgramInfo" class="mb-4"></div>
        <table class="w-full border-collapse">
            <thead>
            <tr class="bg-orange-500 text-black">
                <th class="p-3 text-left" colspan="3">C√°c Kh·ªëi Ki·∫øn Th·ª©c</th>
            </tr>
            <tr class="bg-orange-500 text-black">
                <th class="p-3 text-left"></th>
                <th class="p-3 text-left">S·ªë t√≠n ch·ªâ B·∫Øt bu·ªôc</th>
                <th class="p-3 text-left">S·ªë t√≠n ch·ªâ T·ª± ch·ªçn</th>
            </tr>
            </thead>
            <tbody id="addTableBody">
            <tr class="hover:bg-orange-100">
                <td class="p-3" colspan="3">Kh·ªëi ki·∫øn th·ª©c gi√°o d·ª•c ƒë·∫°i c∆∞∆°ng</td>
            </tr>
            <tr>
                <td class="p-3">Ki·∫øn th·ª©c gi√°o d·ª•c th·ªÉ ch·∫•t v√† qu·ªëc ph√≤ng an ninh</td>
                <td class="p-3"><input type="number" min="1" value="0" class="p-2 border border-gray-300 rounded-lg w-full"></td>
                <td class="p-3"><input type="number" min="1" value="0" class="p-2 border border-gray-300 rounded-lg w-full"></td>
            </tr>
            <tr>
                <td class="p-3">Ki·∫øn th·ª©c ngo·∫°i ng·ªØ</td>
                <td class="p-3"><input type="number" min="1" value="0" class="p-2 border border-gray-300 rounded-lg w-full"></td>
                <td class="p-3"><input type="number" min="1" value="0" class="p-2 border border-gray-300 rounded-lg w-full"></td>
            </tr>
            <tr>
                <td class="p-3">Ki·∫øn th·ª©c l√Ω lu·∫≠n ch√≠nh tr·ªã</td>
                <td class="p-3"><input type="number" min="1"  value="0" class="p-2 border border-gray-300 rounded-lg w-full"></td>
                <td class="p-3"><input type="number" min="1" value="0" class="p-2 border border-gray-300 rounded-lg w-full"></td>
            </tr>
            <tr>
                <td class="p-3">Ki·∫øn th·ª©c gi√°o d·ª•c ƒë·∫°i c∆∞∆°ng kh√°c</td>
                <td class="p-3"><input type="number" min="1" value="0" class="p-2 border border-gray-300 rounded-lg w-full"></td>
                <td class="p-3"><input type="number" min="1" value="0" class="p-2 border border-gray-300 rounded-lg w-full"></td>
            </tr>
            <tr class="hover:bg-orange-100">
                <td class="p-3" colspan="3">Kh·ªëi ki·∫øn th·ª©c gi√°o d·ª•c chuy√™n nghi·ªáp</td>
            </tr>
            <tr>
                <td class="p-3">Ki·∫øn th·ª©c c∆° s·ªü ng√†nh</td>
                <td class="p-3"><input type="number" min="1" value="0" class="p-2 border border-gray-300 rounded-lg w-full"></td>
                <td class="p-3"><input type="number" min="1" value="0" class="p-2 border border-gray-300 rounded-lg w-full"></td>
            </tr>
            <tr>
                <td class="p-3">Ki·∫øn th·ª©c ng√†nh</td>
                <td class="p-3"><input type="number" min="1" value="0" class="p-2 border border-gray-300 rounded-lg w-full"></td>
                <td class="p-3"><input type="number" min="1" value="0" class="p-2 border border-gray-300 rounded-lg w-full"></td>
            </tr>
            <tr>
                <td class="p-3">Ki·∫øn th·ª©c chuy√™n ng√†nh</td>
                <td class="p-3"><input type="number" min="1" value="0" class="p-2 border border-gray-300 rounded-lg w-full"></td>
                <td class="p-3"><input type="number" min="1" value="0" class="p-2 border border-gray-300 rounded-lg w-full"></td>
            </tr>
            </tbody>
        </table>
        <button class="btn-green px-6 py-3 rounded-lg mt-4" id="btnAdd" >Th√™m</button>
    </div>
</div>

<!-- Modal for Delete Confirmation -->
<div id="deleteModal" class="modal">
    <div class="modal-content">
            <span class="close text-2xl font-bold text-gray-500 float-right cursor-pointer"
                  onclick="closeModal('deleteModal')">√ó</span>
        <h2 class="text-2xl font-semibold text-gray-700 mb-4">X√°c Nh·∫≠n X√≥a</h2>
        <p class="text-lg">B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a ch∆∞∆°ng tr√¨nh khung ng√†nh <span id="deleteMajorName"></span>
            kh√¥ng?</p>
        <div class="flex gap-4 mt-4">
            <button class="btn-red px-6 py-3 rounded-lg" onclick="confirmDelete()">X√≥a</button>
            <button class="btn-gray px-6 py-3 rounded-lg" onclick="closeModal('deleteModal')">H·ªßy</button>
        </div>
    </div>
</div>
<script th:inline="javascript">
    // L·∫•y th√¥ng tin quy·ªÅn t·ª´ server
    const isAdmin = /*[[${isAdmin}]]*/ true; // ƒê·∫∑t true ƒë·ªÉ test, sau ƒë√≥ ki·ªÉm tra server side
    const userRole = /*[[${userRole}]]*/ '';

    // Bi·∫øn to√†n c·ª•c ƒë·ªÉ l∆∞u tr·ªØ danh s√°ch ch∆∞∆°ng tr√¨nh
    let programs = [];

    // ·∫®n/hi·ªán c√°c n√∫t ch·ª©c nƒÉng d·ª±a v√†o quy·ªÅn
    function checkPermission() {
        const adminButtons = document.querySelectorAll('.btn-orange, .btn-yellow, .btn-red');
        adminButtons.forEach(button => {
            button.style.display = isAdmin ? 'inline-block' : 'none';
        });

        // ·∫®n c√°c modal kh√¥ng c·∫ßn thi·∫øt n·∫øu kh√¥ng ph·∫£i admin
        if (!isAdmin) {
            const addModal = document.getElementById('addModal');
            const editModal = document.getElementById('editModal');
            const deleteModal = document.getElementById('deleteModal');
            if (addModal) addModal.style.display = 'none';
            if (editModal) editModal.style.display = 'none';
            if (deleteModal) deleteModal.style.display = 'none';
        }
    }
       async function fetchCTDaoTaoById(mactdt) {
        try {
            const response = await fetch(`/api/CTDT_View/${mactdt}`);
            if (!response.ok) {
                if (response.status === 404) throw new Error('Kh√¥ng t√¨m th·∫•y ch∆∞∆°ng tr√¨nh ƒë√†o t·∫°o');
                throw new Error('L·ªói khi l·∫•y th√¥ng tin ch∆∞∆°ng tr√¨nh ƒë√†o t·∫°o');
            }
            return await response.json();
        } catch (error) {
            console.error('L·ªói:', error.message);
            throw error;
        }
    }
    // G·ªçi danh s√°ch ch∆∞∆°ng tr√¨nh ƒë√†o t·∫°o ƒë√£ c√≥ ch∆∞∆°ng tr√¨nh khung
    async function fetchCTDTDaCoKhung() {
        try {
            const response = await fetch('/api/CTDT_View/da-co-khung');
            if (response.status === 204) {
                console.log("Kh√¥ng c√≥ d·ªØ li·ªáu CTƒêT ƒë√£ c√≥ khung.");
                programs = [];
                return;
            } else if (!response.ok) {
                throw new Error(`L·ªói khi g·ªçi API /da-co-khung: ${response.statusText}`);
            }
            programs = await response.json();
            console.log("Danh s√°ch CTƒêT ƒë√£ c√≥ khung (programs):", programs);

            const tableBody = document.getElementById('programTableBody');
            tableBody.innerHTML = ""; // X√≥a n·ªôi dung c≈©

            if (!Array.isArray(programs) || programs.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="3" class="p-4 text-center text-gray-500">Kh√¥ng c√≥ ch∆∞∆°ng tr√¨nh ƒë√†o t·∫°o n√†o.</td></tr>';
                return;
            }

            programs.forEach((program, index) => {
                console.log(`Rendering row ${index} (da-co-khung):`, program); // Log t·ª´ng d√≤ng d·ªØ li·ªáu

                // Ki·ªÉm tra d·ªØ li·ªáu h·ª£p l·ªá
                if (!program || typeof program !== 'object' || program.maCTDT === undefined || program.tenCTDT === undefined) {
                    console.error(`D·ªØ li·ªáu kh√¥ng h·ª£p l·ªá t·∫°i index ${index} (da-co-khung):`, program);
                    return; // B·ªè qua n·∫øu d·ªØ li·ªáu kh√¥ng h·ª£p l·ªá
                }

                // T·∫°o h√†ng b·∫£ng th·ªß c√¥ng
                const row = document.createElement("tr");
                row.className = "hover:bg-orange-100";

                // C·ªôt M√É CTDT
                const tdMaCtdt = document.createElement("td");
                tdMaCtdt.className = "p-4";
                tdMaCtdt.textContent = program.maCTDT !== undefined ? program.maCTDT.toString() : 'N/A';
                row.appendChild(tdMaCtdt);

                // C·ªôt T√äN CTDT
                const tdTenCtdt = document.createElement("td");
                tdTenCtdt.className = "p-4";
                tdTenCtdt.textContent = program.tenCTDT !== undefined ? program.tenCTDT : 'N/A';
                row.appendChild(tdTenCtdt);

                // C·ªôt THAO T√ÅC
                const tdActions = document.createElement("td");
                tdActions.className = "p-4 flex gap-2";
                tdActions.innerHTML = `
                    <button class="btn-green px-4 py-2 rounded-lg" onclick="viewDetails(${program.maCTDT})">Xem chi ti·∫øt</button>
                    ${isAdmin ? `
                        <button class="btn-yellow px-4 py-2 rounded-lg" onclick="editProgram(${program.maCTDT})">S·ª≠a</button>
                    ` : ''}
                `;
                row.appendChild(tdActions);

                tableBody.appendChild(row);
            });
        } catch (error) {
            console.error("L·ªói fetchCTDTDaCoKhung:", error);
            const tableBody = document.getElementById('programTableBody');
            tableBody.innerHTML = '<tr><td colspan="3" class="p-4 text-center text-red-500">L·ªói khi t·∫£i d·ªØ li·ªáu.</td></tr>';
        }
    }

    // G·ªçi danh s√°ch c√°c ch∆∞∆°ng tr√¨nh ƒë√†o t·∫°o ch∆∞a c√≥ ch∆∞∆°ng tr√¨nh khung
    async function fetchCTDTChuaCoKhung() {
        try {
            const response = await fetch('/api/CTDT_View/chua-co-khung');
            if (response.status === 204) {
                console.log("Kh√¥ng c√≥ d·ªØ li·ªáu CTƒêT ch∆∞a c√≥ khung.");
                return [];
            } else if (!response.ok) {
                throw new Error(`L·ªói khi g·ªçi API /chua-co-khung: ${response.statusText}`);
            }
            const ctDaoTaoList = await response.json();
            console.log("Danh s√°ch CTƒêT ch∆∞a c√≥ khung:", ctDaoTaoList);

            const tableBody = document.getElementById('programSelectTableBody');
            tableBody.innerHTML = "";
            if (!Array.isArray(ctDaoTaoList) || ctDaoTaoList.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="3" class="p-4 text-center text-gray-500">Kh√¥ng c√≤n ch∆∞∆°ng tr√¨nh ƒë√†o t·∫°o n√†o ƒë·ªÉ th√™m.</td></tr>';
            } else {
                ctDaoTaoList.forEach((program, index) => {

                    // Ki·ªÉm tra d·ªØ li·ªáu h·ª£p l·ªá
                    if (!program || typeof program !== 'object' || program.maCTDT === undefined || program.tenCTDT === undefined) {
                        console.error(`D·ªØ li·ªáu kh√¥ng h·ª£p l·ªá t·∫°i index ${index} (chua-co-khung):`, program);
                        return; // B·ªè qua n·∫øu d·ªØ li·ªáu kh√¥ng h·ª£p l·ªá
                    }

                    // T·∫°o h√†ng b·∫£ng th·ªß c√¥ng
                    const row = document.createElement("tr");
                    row.className = "hover:bg-orange-100";

                    // C·ªôt M√É CTDT
                    const tdMaCtdt = document.createElement("td");
                    tdMaCtdt.className = "p-3";
                    tdMaCtdt.textContent = program.maCTDT !== undefined ? program.maCTDT.toString() : 'N/A';
                    row.appendChild(tdMaCtdt);

                    // C·ªôt T√äN CTDT
                    const tdTenCtdt = document.createElement("td");
                    tdTenCtdt.className = "p-3";
                    tdTenCtdt.textContent = program.tenCTDT !== undefined ? program.tenCTDT : 'N/A';
                    row.appendChild(tdTenCtdt);

                    // C·ªôt H√†nh ƒë·ªông
                    const tdAction = document.createElement("td");
                    tdAction.className = "p-3";
                    tdAction.innerHTML = `
                        <button class="btn-green px-4 py-2 rounded-lg" onclick="selectProgram('${program.maCTDT}', '${program.tenCTDT}')">Ch·ªçn</button>
                    `;
                    row.appendChild(tdAction);

                    tableBody.appendChild(row);
                });
            }
        } catch (error) {
            console.error("L·ªói fetchCTDTChuaCoKhung:", error);
            const tableBody = document.getElementById('programSelectTableBody');
            tableBody.innerHTML = '<tr><td colspan="3" class="p-4 text-center text-red-500">L·ªói khi t·∫£i d·ªØ li·ªáu.</td></tr>';
        }
    }

            // Tr·∫£ v·ªÅ Promise ch·ª©a data
      function fetchMaxMaKhung() {
          return fetch("http://localhost:8080/api/khungchuongtrinh/maxId")
              .then(response => {
                  if (!response.ok) {
                      throw new Error("L·ªói khi g·ªçi API");
                  }
                  return response.json();
              })
              .then(data => {
                  console.log("Max m√£ khung:", data);
                  return data;
              })
              .catch(error => {
                  console.error("L·ªói khi fetch maxId khung:", error);
                  throw error;
              });
      }

      function fetchMaxMaKhoiKienThuc() {
          return fetch("http://localhost:8080/api/khoikienthuc/maxId")
              .then(response => {
                  if (!response.ok) {
                      throw new Error("L·ªói khi g·ªçi API");
                  }
                  return response.json();
              })
              .then(data => {
                  console.log("Max m√£ kh·ªëi ki·∫øn th·ª©c:", data);
                  return data; // <-- QUAN TR·ªåNG
              })
              .catch(error => {
                  console.error("L·ªói khi fetch maxId kh·ªëi ki·∫øn th·ª©c:", error);
                  throw error;
              });
      }
      //L·∫•y ch∆∞∆°ng tr√¨nh khung b·∫±ng m√£ ctdt
      async function fetchCTKhungByMaCTDT(maCTDT) {
          try {
              const response = await fetch(`/api/khungchuongtrinh/theomaCTDT/${maCTDT}`);
              if (!response.ok) {
                  throw new Error(`HTTP error! Status: ${response.status}`);
              }
              const data = await response.json();
              return data;
          } catch (error) {
              console.error("L·ªói khi g·ªçi API CTKhung theo maCTDT:", error);
              return null;
          }
      }



      //L·∫•y danh s√°ch kh·ªëi ki·∫øn th·ª©c b·ªüi m√£ khung
      async function fetchKhoiKienThucByMaKhung(maKhung) {
          try {
              const response = await fetch(`/api/khoikienthuc/byKhung/${maKhung}`);
              if (!response.ok) {
                  throw new Error(`L·ªói khi g·ªçi API: ${response.status}`);
              }
              const data = await response.json();
              return data;
          } catch (error) {
              console.error("L·ªói khi l·∫•y kh·ªëi ki·∫øn th·ª©c theo maKhung:", error);
              return null;
          }
      }




      // Bi·∫øn l∆∞u tr·ªØ d·ªØ li·ªáu to√†n c·ª•c sau khi g·ªçi selectProgram
      let newMaKhungGlobal = null;
      let list_newKhoiKienThucGlobal = [];

      async function selectProgram(maCTDT, tenCTDT) {
            document.getElementById("selectProgramModal").style.display = "none";
            document.getElementById("addModal").style.display = "block";
            document.getElementById("selectedProgramInfo").innerHTML = `
                  <p class="text-lg font-medium text-gray-700">
                        Ch∆∞∆°ng tr√¨nh: ${tenCTDT} m√£ (${maCTDT})
                  </p>
            `;

            try {
                  const maxMaKhung = parseInt(await fetchMaxMaKhung(), 10) || 0;
                  const newMaKhung = maxMaKhung + 1;

                  const maxMaKhoiKienThuc = parseInt(await fetchMaxMaKhoiKienThuc(), 10) || 0;
                  let nextMaKhoi = maxMaKhoiKienThuc + 1;

                  const rows = document.querySelectorAll("#addTableBody tr");
                  rows.forEach((row) => {
                        const inputs = row.querySelectorAll("input");
                        if (inputs.length === 2) {
                              inputs.forEach(input => {
                                    input.setAttribute("data-khoikienthuc", nextMaKhoi);
                              });
                              nextMaKhoi++;
                        }
                  });
                    // G√°n v√†o bi·∫øn to√†n c·ª•c ƒë·ªÉ btnAdd d√πng ƒë∆∞·ª£c
                    const ctDaoTao = await fetchCTDaoTaoById(maCTDT);
                    newMaKhungGlobal = {
                        makhung: newMaKhung,
                        mactdt: maCTDT
                    };
                  const allInputs = document.querySelectorAll("#addTableBody input");
                  const list_newKhoiKienThuc = [];
                  for (let i = 0; i < allInputs.length; i += 2) {
                        const inpBB = allInputs[i];
                        const inpTC = allInputs[i + 1];
                        const makhoikienthuc = parseInt(inpBB.dataset.khoikienthuc, 10);

                        list_newKhoiKienThuc.push({
                              makhung: newMaKhung,
                              makhoikienthuc: makhoikienthuc,
                              tinbatbuoc: parseInt(inpBB.value, 10) || 0,
                              tintuchon: parseInt(inpTC.value, 10) || 0
                        });
                  }


                  list_newKhoiKienThucGlobal = list_newKhoiKienThuc;

                  console.log("Kh·ªüi t·∫°o ban ƒë·∫ßu:");
                  console.log("newMaKhung:", newMaKhungGlobal);
                  console.log("list_newKhoiKienThuc:", list_newKhoiKienThucGlobal);

            } catch (error) {
                  console.error("L·ªói khi x·ª≠ l√Ω selectProgram:", error);
            }
      }
        async function addCTKhung(maCTDT, maKhung) {
            try {
                const response = await fetch(`http://localhost:8080/api/khungchuongtrinh?maCTDT=${maCTDT}&maKhung=${maKhung}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const result = await response.text();

                if (response.ok) {
                    return { success: true, message: result };
                } else {
                    return { success: false, message: result || 'ƒê√£ x·∫£y ra l·ªói khi th√™m CTKhung.' };
                }
            } catch (error) {
                return { success: false, message: 'L·ªói k·∫øt n·ªëi: ' + error.message };
            }
        }
        async function addKhoiKienThuc(maKhoiKienThuc, maKhung, tinChiBatBuoc, tinChiTuChon) {
            try {
                const params = new URLSearchParams({
                    maKhoiKienThuc: maKhoiKienThuc,
                    maKhung: maKhung,
                    tinChiBatBuoc: tinChiBatBuoc,
                    tinChiTuChon: tinChiTuChon
                });

                const response = await fetch(`http://localhost:8080/api/khoikienthuc?${params.toString()}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded', // ho·∫∑c c√≥ th·ªÉ kh√¥ng c·∫ßn header n√†y
                    }
                });

                const text = await response.text();
                if (response.ok) {
                    return { success: true, message: text };
                } else {
                    return { success: false, message: text };
                }
            } catch (error) {
                return { success: false, message: 'L·ªói k·∫øt n·ªëi: ' + error.message };
            }
        }

        document.getElementById("btnAdd").addEventListener("click", async () => {
            if (!list_newKhoiKienThucGlobal || list_newKhoiKienThucGlobal.length === 0) {
                console.warn("Ch∆∞a ch·ªçn ch∆∞∆°ng tr√¨nh ƒë√†o t·∫°o!");
                alert("Vui l√≤ng ch·ªçn ch∆∞∆°ng tr√¨nh ƒë√†o t·∫°o tr∆∞·ªõc!");
                return;
            }

            // Update list_newKhoiKienThucGlobal with input values
            const allInputs = document.querySelectorAll("#addTableBody input");
            for (let i = 0; i < allInputs.length; i += 2) {
                const inpBB = allInputs[i];
                const inpTC = allInputs[i + 1];
                const makhoikienthuc = parseInt(inpBB.dataset.khoikienthuc, 10);

                const item = list_newKhoiKienThucGlobal.find(x => x.makhoikienthuc === makhoikienthuc);
                if (item) {
                    item.tinbatbuoc = parseInt(inpBB.value, 10) || 0;
                    item.tintuchon = parseInt(inpTC.value, 10) || 0;
                }
            }

            console.log("‚úÖ D·ªØ li·ªáu sau khi c·∫≠p nh·∫≠t t·ª´ input:");
            console.log("newMaKhung:", newMaKhungGlobal);
            console.log("list_newKhoiKienThuc:", list_newKhoiKienThucGlobal);

            try {
                // Add CTKhung first
                const ctKhungResult = await addCTKhung(newMaKhungGlobal.mactdt, newMaKhungGlobal.makhung);
                if (!ctKhungResult.success) {
                    console.error("L·ªói khi th√™m CTKhung:", ctKhungResult.message);
                    alert(`T·∫°o ch∆∞∆°ng tr√¨nh khung th·∫•t b·∫°i: ${ctKhungResult.message}`);
                    return;
                }
                console.log("Th√™m CTKhung th√†nh c√¥ng:", ctKhungResult.message);

                // Add all KhoiKienThuc entries
                const khoiKienThucPromises = list_newKhoiKienThucGlobal.map(item =>
                    addKhoiKienThuc(
                        item.makhoikienthuc,
                        item.makhung,
                        item.tinbatbuoc,
                        item.tintuchon
                    )
                );

                const khoiKienThucResults = await Promise.all(khoiKienThucPromises);

                // Check if all KhoiKienThuc calls were successful
                const allSuccessful = khoiKienThucResults.every(result => result.success);
                if (allSuccessful) {
                    alert("T·∫°o ch∆∞∆°ng tr√¨nh khung v√† kh·ªëi ki·∫øn th·ª©c th√†nh c√¥ng!");
                } else {
                    const errorMessages = khoiKienThucResults
                        .filter(result => !result.success)
                        .map(result => result.message)
                        .join("; ");
                    console.error("L·ªói khi th√™m m·ªôt ho·∫∑c nhi·ªÅu kh·ªëi ki·∫øn th·ª©c:", errorMessages);
                    alert(`T·∫°o ch∆∞∆°ng tr√¨nh khung th√†nh c√¥ng, nh∆∞ng l·ªói khi th√™m kh·ªëi ki·∫øn th·ª©c: ${errorMessages}`);
                    closeModal(addModal);
                }

                // Reset inputs and global variables
                allInputs.forEach(input => {
                    input.value = 0;
                });
                newMaKhungGlobal = null;
                list_newKhoiKienThucGlobal = [];
                console.log("ƒê√£ reset xong input v√† bi·∫øn to√†n c·ª•c.");
            } catch (error) {
                console.error("L·ªói trong qu√° tr√¨nh th√™m ch∆∞∆°ng tr√¨nh khung ho·∫∑c kh·ªëi ki·∫øn th·ª©c:", error);
                alert(`L·ªói: ${error.message}`);
            }
        });

    // Load programs on page load
    async function loadPrograms() {
        await fetchCTDTDaCoKhung();
    }

    // Open modal to select program
    function openSelectProgramModal() {
        fetchCTDTChuaCoKhung();
        document.getElementById("selectProgramModal").style.display = "block";
    }


    // Hi·ªÉn th·ªã xem chi ti·∫øt
    function viewDetails(index) {
        alert(`B·∫°n mu·ªën xem chi ti·∫øt ch∆∞∆°ng tr√¨nh khung c·ªßa CTDT c√≥ m√£ -${index}`);
        renderDataToDetailModal(index)
        document.getElementById("viewModal").style.display = "block";
    }

    // Edit program
    function editProgram(index) {
        alert(`B·∫°n mu·ªën xem chi ti·∫øt ch∆∞∆°ng tr√¨nh khung c·ªßa CTDT c√≥ m√£ -${index}`);
        renderDataToEditModal(index);
        document.getElementById("editModal").style.display = "block";
    }

  async function renderDataToDetailModal(maCTDT) {
      const ctKhungList = await fetchCTKhungByMaCTDT(maCTDT);

      if (ctKhungList && ctKhungList.length === 1) {
          const maKhung = ctKhungList[0].maKhung;
          const khoiKTList = await fetchKhoiKienThucByMaKhung(maKhung);

          console.log("CTKhung List:", ctKhungList);
          console.log("Kh·ªëi Ki·∫øn Th·ª©c List:", khoiKTList);

          const allInputs = document.querySelectorAll("#detailTableBody input");

          for (let i = 0; i < allInputs.length; i += 2) {
              const inpBB = allInputs[i];
              const inpTC = allInputs[i + 1];
              const index = i / 2;

              if (khoiKTList[index]) {
                  inpBB.value = parseInt(khoiKTList[index].tinChiBatBuoc, 10) || 0;
                  inpTC.value = parseInt(khoiKTList[index].tinChiTuChon, 10) || 0;
                  // V√¥ hi·ªáu h√≥a input ƒë·ªÉ ch·ªâ cho xem
                  inpBB.disabled = true;
                  inpTC.disabled = true;
              }
          }
      } else {
          console.log("Kh√¥ng l·∫•y ƒë∆∞·ª£c d·ªØ li·ªáu ho·∫∑c c√≥ nhi·ªÅu h∆°n m·ªôt khung ch∆∞∆°ng tr√¨nh.");
      }
  }
  // Bi·∫øn l∆∞u tr·ªØ d·ªØ li·ªáu to√†n c·ª•c
  let ctKhungList = null;
  let khoiKTList = [];

  async function renderDataToEditModal(maCTDT) {
      ctKhungList = await fetchCTKhungByMaCTDT(maCTDT);

      if (ctKhungList && ctKhungList.length === 1) {
          const maKhung = ctKhungList[0].maKhung;
          khoiKTList = await fetchKhoiKienThucByMaKhung(maKhung);

          console.log("CTKhung List:", ctKhungList);
          console.log("Kh·ªëi Ki·∫øn Th·ª©c List:", khoiKTList);

          const rows = document.querySelectorAll("#editTableBody tr");
          let index = 0;
          rows.forEach((row) => {
              const inputs = row.querySelectorAll("input");
              if (inputs.length === 2 && khoiKTList[index]) {
                  const { maKhoiKienThuc, tinChiBatBuoc, tinChiTuChon } = khoiKTList[index];

                  // G√°n data attribute ƒë·ªÉ l∆∞u m√£ kh·ªëi ki·∫øn th·ª©c
                  inputs[0].setAttribute("data-khoikienthuc", maKhoiKienThuc);
                  inputs[1].setAttribute("data-khoikienthuc", maKhoiKienThuc);

                  // G√°n gi√° tr·ªã t√≠n ch·ªâ v√†o input
                  inputs[0].value = parseInt(tinChiBatBuoc, 10) || 0;
                  inputs[1].value = parseInt(tinChiTuChon, 10) || 0;

                  index++;
              }
          });
      } else {
          console.warn("Kh√¥ng l·∫•y ƒë∆∞·ª£c d·ªØ li·ªáu ho·∫∑c c√≥ nhi·ªÅu h∆°n m·ªôt khung ch∆∞∆°ng tr√¨nh.");
      }
  }

        async function updateKhoiKienThuc(maKhoiKienThuc, tinChiBatBuoc, tinChiTuChon) {
            try {
                const response = await fetch(`http://localhost:8080/api/khoikienthuc/${maKhoiKienThuc}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        tinChiBatBuoc,
                        tinChiTuChon
                    })
                });

                const result = await response.text();
                return response.ok
                    ? { success: true, message: result }
                    : { success: false, message: result || 'L·ªói khi c·∫≠p nh·∫≠t KhoiKienThuc' };
            } catch (error) {
                return { success: false, message: 'LW·ªói k·∫øt n·ªëi: ' + error.message };
            }
        }
        document.getElementById("btnEdit").addEventListener("click", async () => {
            if (!khoiKTList || khoiKTList.length === 0) {
                console.warn("‚ö†Ô∏è Vui l√≤ng ch·ªçn ch∆∞∆°ng tr√¨nh ƒë√†o t·∫°o tr∆∞·ªõc!");
                alert("Vui l√≤ng ch·ªçn ch∆∞∆°ng tr√¨nh ƒë√†o t·∫°o tr∆∞·ªõc!");
                return;
            }

            // Update khoiKTList with input values
            const allInputs = document.querySelectorAll("#editTableBody input");
            for (let i = 0; i < allInputs.length; i += 2) {
                const inpBB = allInputs[i];
                const inpTC = allInputs[i + 1];
                const maKhoiKienThuc = parseInt(inpBB.dataset.khoikienthuc, 10);

                const khoi = khoiKTList.find(k => k.maKhoiKienThuc === maKhoiKienThuc);
                if (khoi) {
                    khoi.tinChiBatBuoc = parseInt(inpBB.value, 10) || 0;
                    khoi.tinChiTuChon = parseInt(inpTC.value, 10) || 0;
                }
            }

            console.log("‚úÖ D·ªØ li·ªáu sau khi c·∫≠p nh·∫≠t t·ª´ input:");
            console.log("Ch∆∞∆°ng tr√¨nh khung:", ctKhungList);
            console.log("Danh s√°ch kh·ªëi ki·∫øn th·ª©c sau c·∫≠p nh·∫≠t:", khoiKTList);

            try {
                // Update all KhoiKienThuc entries
                const updatePromises = khoiKTList.map(khoi =>
                    updateKhoiKienThuc(
                        khoi.maKhoiKienThuc,
                        khoi.tinChiBatBuoc,
                        khoi.tinChiTuChon
                    )
                );

                const updateResults = await Promise.all(updatePromises);

                // Check if all updates were successful
                const allSuccessful = updateResults.every(result => result.success);
                if (allSuccessful) {
                    alert("C·∫≠p nh·∫≠t kh·ªëi ki·∫øn th·ª©c th√†nh c√¥ng!");
                } else {
                    const errorMessages = updateResults
                        .filter(result => !result.success)
                        .map(result => result.message)
                        .join("; ");
                    console.error("L·ªói khi c·∫≠p nh·∫≠t m·ªôt ho·∫∑c nhi·ªÅu kh·ªëi ki·∫øn th·ª©c:", errorMessages);
                    alert(`L·ªói khi c·∫≠p nh·∫≠t kh·ªëi ki·∫øn th·ª©c: ${errorMessages}`);
                    return;
                }

                // Reset inputs and global variables only on success
                allInputs.forEach(input => {
                    input.value = 0;
                });
                ctKhungList = null;
                khoiKTList = [];
                console.log("üîÑ ƒê√£ reset input v√† bi·∫øn to√†n c·ª•c.");

            } catch (error) {
                console.error("L·ªói trong qu√° tr√¨nh c·∫≠p nh·∫≠t kh·ªëi ki·∫øn th·ª©c:", error);
                alert(`L·ªói: ${error.message}`);
            }
        });


    // Delete program
    function openDeleteModal(index) {
         alert(`B·∫°n mu·ªën xem chi ti·∫øt ch∆∞∆°ng tr√¨nh khung c·ªßa CTDT c√≥ m√£:${index}`);
        document.getElementById("deleteMajorName").textContent = index|| "Kh√¥ng x√°c ƒë·ªãnh";
        document.getElementById("deleteModal").style.display = "block";
    }

    function confirmDelete() {
        alert("Ch·ª©c nƒÉng x√≥a ch∆∞a ƒë∆∞·ª£c tri·ªÉn khai ho√†n ch·ªânh. Vui l√≤ng cung c·∫•p API x√≥a ch∆∞∆°ng tr√¨nh.");
        closeModal("deleteModal");
    }


    // ƒê√≥ng c√°c modal
    function closeModal(modalId) {
        document.getElementById(modalId).style.display = "none";
        if (modalId === "addModal") {
            selectedProgram = null;
            document.getElementById("selectedProgramInfo").innerHTML = "";
        }
    }

    // G·ªçi h√†m ki·ªÉm tra quy·ªÅn v√† load programs khi trang load
    window.onload = async function () {
        checkPermission();
        await loadPrograms();
    };
</script>

</body>

</html>