<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.w3.org/1999/xhtml">
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản Lý Chương Trình Khung CNTT</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

        body {
            font-family: 'Inter', sans-serif;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 10;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 1.5rem;
            border-radius: 0.75rem;
            width: 100%;
            max-width: 900px;
        }

        .program-select-table {
            max-height: 300px;
            overflow-y: auto;
        }

        .btn-orange {
            background: linear-gradient(to right, #f97316, #fb923c);
            color: white;
            transition: all 0.3s ease;
        }

        .btn-orange:hover {
            background: linear-gradient(to right, #ea580c, #f97316);
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(249, 115, 22, 0.3);
        }

        .btn-green {
            background: linear-gradient(to right, #4CAF50, #66BB6A);
            color: white;
            transition: all 0.3s ease;
        }

        .btn-green:hover {
            background: linear-gradient(to right, #388E3C, #4CAF50);
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);
        }

        .btn-yellow {
            background: linear-gradient(to right, #FFC107, #FFCA28);
            color: white;
            transition: all 0.3s ease;
        }

        .btn-yellow:hover {
            background: linear-gradient(to right, #FFA000, #FFC107);
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(255, 193, 7, 0.3);
        }

        .btn-red {
            background: linear-gradient(to right, #F44336, #EF5350);
            color: white;
            transition: all 0.3s ease;
        }

        .btn-red:hover {
            background: linear-gradient(to right, #D32F2F, #F44336);
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(244, 67, 54, 0.3);
        }

        .btn-gray {
            background: linear-gradient(to right, #B0BEC5, #CFD8DC);
            color: white;
            transition: all 0.3s ease;
        }

        .btn-gray:hover {
            background: linear-gradient(to right, #90A4AE, #B0BEC5);
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(176, 190, 197, 0.3);
        }

        table tr:nth-child(even) {
            background-color: #fef5e7;
        }

        table tr:hover {
            background-color: #ffedd5;
            transition: background-color 0.2s ease;
        }

        input:focus,
        select:focus {
            border-color: #f97316;
            box-shadow: 0 0 0 3px rgba(249, 115, 22, 0.1);
        }

        /* Thêm style cho nút trở về trang chủ */
        .back-home-btn {
            position: fixed;
            top: 20px;
            left: 20px;
            padding: 10px 20px;
            background: linear-gradient(to right, #f97316, #fb923c);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            text-decoration: none;
        }

        .back-home-btn:hover {
            background: linear-gradient(to right, #ea580c, #f97316);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }

        .back-home-btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 3px rgba(0,0,0,0.2);
        }

        .back-home-btn i {
            font-size: 18px;
        }
    </style>
    <!-- Thêm Font Awesome để sử dụng icon -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
</head>

<body class="bg-gray-100 min-h-screen p-6">
<!-- Thêm nút trở về trang chủ -->
<a th:href="@{/home}" class="back-home-btn">
    <i class="fas fa-home"></i>
    Trang Chủ
</a>
<div class="container max-w-full mx-auto bg-white p-6 rounded-lg shadow-lg">
    <h1 class="text-3xl font-bold text-center text-orange-600 mb-4">
        QUẢN LÝ CHƯƠNG TRÌNH KHUNG
        <span th:if="${isAdmin}" class="text-sm">(ADMIN)</span>
    </h1>
    <button class="btn-orange px-6 py-3 rounded-lg mb-6" th:if="${isAdmin}" onclick="openSelectProgramModal()">
        + Thêm CTKhung Mới
    </button>
    <div class="overflow-x-auto">
        <table class="w-full border-collapse">
            <thead>
            <tr class="bg-orange-500 text-white">
                <th class="p-4 text-left">MÃ CTDT</th>
                <th class="p-4 text-left">TÊN CTDT</th>
                <th class="p-4 text-left">THAO TÁC</th>
            </tr>
            </thead>
            <tbody id="programTableBody"></tbody>
        </table>
    </div>
</div>

<!-- Modal for Selecting Program -->
<div id="selectProgramModal" class="modal">
    <div class="modal-content">
            <span class="close text-2xl font-bold text-gray-500 float-right cursor-pointer"
                  onclick="closeModal('selectProgramModal')">×</span>
        <h2 class="text-2xl font-semibold text-gray-700 mb-4">Chọn Chương Trình Đào Tạo</h2>
        <div class="program-select-table">
            <table class="w-full border-collapse">
                <thead>
                <tr class="bg-orange-500 text-white">
                    <th class="p-3 text-left">Mã CTDT</th>
                    <th class="p-3 text-left">Tên CTDT</th>
                    <th class="p-3 text-left">Hành động</th>
                </tr>
                </thead>
                <tbody id="programSelectTableBody"></tbody>
            </table>
        </div>
    </div>
</div>

<!-- Modal for Viewing Details -->
<div id="viewModal" class="modal">
    <div class="modal-content">
        <span class="close text-2xl font-bold text-gray-500 float-right cursor-pointer"
              onclick="closeModal('viewModal')">×</span>
        <h2 class="text-2xl font-semibold text-gray-700 mb-4">Chi Tiết Chương Trình Khung</h2>
        <table class="w-full border-collapse">
            <thead>
            <tr class="bg-orange-500 text-black">
                <th class="p-3 text-left" colspan="3">Các Khối Kiến Thức</th>
            </tr>
            <tr class="bg-orange-500 text-black">
                <th class="p-3 text-left"></th>
                <th class="p-3 text-left">Số tín chỉ Bắt buộc</th>
                <th class="p-3 text-left">Số tín chỉ Tự chọn</th>
            </tr>
            </thead>
            <tbody id="detailTableBody">
            <tr class="hover:bg-orange-100">
                <td class="p-3" colspan="3">Khối kiến thức giáo dục đại cương</td>
            </tr>
            <tr>
                <td class="p-3">Kiến thức giáo dục thể chất và quốc phòng an ninh</td>
                <td class="p-3"><input type="number" min="1" value="0" class="p-2 border border-gray-300 rounded-lg w-full"></td>
                <td class="p-3"><input type="number" min="1" value="0" class="p-2 border border-gray-300 rounded-lg w-full"></td>
            </tr>
            <tr>
                <td class="p-3">Kiến thức ngoại ngữ</td>
                <td class="p-3"><input type="number" min="1" value="0" class="p-2 border border-gray-300 rounded-lg w-full"></td>
                <td class="p-3"><input type="number" min="1" value="0" class="p-2 border border-gray-300 rounded-lg w-full"></td>
            </tr>
            <tr>
                <td class="p-3">Kiến thức lý luận chính trị</td>
                <td class="p-3"><input type="number" min="1" value="0" class="p-2 border border-gray-300 rounded-lg w-full"></td>
                <td class="p-3"><input type="number" min="1" value="0" class="p-2 border border-gray-300 rounded-lg w-full"></td>
            </tr>
            <tr>
                <td class="p-3">Kiến thức giáo dục đại cương khác</td>
                <td class="p-3"><input type="number" min="1" value="0" class="p-2 border border-gray-300 rounded-lg w-full"></td>
                <td class="p-3"><input type="number" min="1" value="0" class="p-2 border border-gray-300 rounded-lg w-full"></td>
            </tr>
            <tr class="hover:bg-orange-100">
                <td class="p-3" colspan="3">Khối kiến thức giáo dục chuyên nghiệp</td>
            </tr>
            <tr>
                <td class="p-3">Kiến thức cơ sở ngành</td>
                <td class="p-3"><input type="number" min="1" value="0" class="p-2 border border-gray-300 rounded-lg w-full"></td>
                <td class="p-3"><input type="number" min="1" value="0" class="p-2 border border-gray-300 rounded-lg w-full"></td>
            </tr>
            <tr>
                <td class="p-3">Kiến thức ngành</td>
                <td class="p-3"><input type="number" min="1" value="0" class="p-2 border border-gray-300 rounded-lg w-full"></td>
                <td class="p-3"><input type="number" min="1" value="0" class="p-2 border border-gray-300 rounded-lg w-full"></td>
            </tr>
            <tr>
                <td class="p-3">Kiến thức chuyên ngành</td>
                <td class="p-3"><input type="number" min="1" value="0" class="p-2 border border-gray-300 rounded-lg w-full"></td>
                <td class="p-3"><input type="number" min="1" value="0" class="p-2 border border-gray-300 rounded-lg w-full"></td>
            </tr>
            </tbody>
        </table>
    </div>
</div>


<!-- Modal for Editing -->
<div id="editModal" class="modal">
    <div class="modal-content">
            <span class="close text-2xl font-bold text-gray-500 float-right cursor-pointer"
                  onclick="closeModal('editModal')">×</span>
        <h2 class="text-2xl font-semibold text-gray-700 mb-4">Sửa Chương Trình Khung</h2>
        <table class="w-full border-collapse">
            <thead>
            <tr class="bg-orange-500 text-black">
                <th class="p-3 text-left" colspan="3">Các Khối Kiến Thức</th>
            </tr>
            <tr class="bg-orange-500 text-black">
                <th class="p-3 text-left"></th>
                <th class="p-3 text-left">Số tín chỉ Bắt buộc</th>
                <th class="p-3 text-left">Số tín chỉ Tự chọn</th>
            </tr>
            </thead>
            <tbody id="editTableBody">
            <tr class="hover:bg-orange-100">
                <td class="p-3" colspan="3">Khối kiến thức giáo dục đại cương</td>
            </tr>
            <tr>
                <td class="p-3">Kiến thức giáo dục thể chất và quốc phòng an ninh</td>
                <td class="p-3"><input type="number" min="1" value="0" class="p-2 border border-gray-300 rounded-lg w-full"></td>
                <td class="p-3"><input type="number" min="1" value="0" class="p-2 border border-gray-300 rounded-lg w-full"></td>
            </tr>
            <tr>
                <td class="p-3">Kiến thức ngoại ngữ</td>
                <td class="p-3"><input type="number" min="1" value="0" class="p-2 border border-gray-300 rounded-lg w-full"></td>
                <td class="p-3"><input type="number" min="1" value="0" class="p-2 border border-gray-300 rounded-lg w-full"></td>
            </tr>
            <tr>
                <td class="p-3">Kiến thức lý luận chính trị</td>
                <td class="p-3"><input type="number" min="1" value="0" class="p-2 border border-gray-300 rounded-lg w-full"></td>
                <td class="p-3"><input type="number" min="1" value="0" class="p-2 border border-gray-300 rounded-lg w-full"></td>
            </tr>
            <tr>
                <td class="p-3">Kiến thức giáo dục đại cương khác</td>
                <td class="p-3"><input type="number" min="1" value="0" class="p-2 border border-gray-300 rounded-lg w-full"></td>
                <td class="p-3"><input type="number" min="1" value="0" class="p-2 border border-gray-300 rounded-lg w-full"></td>
            </tr>
            <tr class="hover:bg-orange-100">
                <td class="p-3" colspan="3">Khối kiến thức giáo dục chuyên nghiệp</td>
            </tr>
            <tr>
                <td class="p-3">Kiến thức cơ sở ngành</td>
                <td class="p-3"><input type="number" min="1" value="0" class="p-2 border border-gray-300 rounded-lg w-full"></td>
                <td class="p-3"><input type="number" min="1" value="0" class="p-2 border border-gray-300 rounded-lg w-full"></td>
            </tr>
            <tr>
                <td class="p-3">Kiến thức ngành</td>
                <td class="p-3"><input type="number" min="1" value="0" class="p-2 border border-gray-300 rounded-lg w-full"></td>
                <td class="p-3"><input type="number" min="1" value="0" class="p-2 border border-gray-300 rounded-lg w-full"></td>
            </tr>
            <tr>
                <td class="p-3">Kiến thức chuyên ngành</td>
                <td class="p-3"><input type="number" min="1" value="0" class="p-2 border border-gray-300 rounded-lg w-full"></td>
                <td class="p-3"><input type="number" min="1" value="0" class="p-2 border border-gray-300 rounded-lg w-full"></td>
            </tr>
            </tbody>
        </table>
        <button class="btn-green px-6 py-3 rounded-lg mt-4" id="btnEdit">Hoàn Thành</button>
    </div>
</div>

<!-- Modal for Adding New Program -->
<div id="addModal" class="modal">
    <div class="modal-content">
            <span class="close text-2xl font-bold text-gray-500 float-right cursor-pointer"
                  onclick="closeModal('addModal')">×</span>
        <h2 class="text-2xl font-semibold text-gray-700 mb-4">Thêm Chương Trình Khung Mới</h2>
        <div id="selectedProgramInfo" class="mb-4"></div>
        <table class="w-full border-collapse">
            <thead>
            <tr class="bg-orange-500 text-black">
                <th class="p-3 text-left" colspan="3">Các Khối Kiến Thức</th>
            </tr>
            <tr class="bg-orange-500 text-black">
                <th class="p-3 text-left"></th>
                <th class="p-3 text-left">Số tín chỉ Bắt buộc</th>
                <th class="p-3 text-left">Số tín chỉ Tự chọn</th>
            </tr>
            </thead>
            <tbody id="addTableBody">
            <tr class="hover:bg-orange-100">
                <td class="p-3" colspan="3">Khối kiến thức giáo dục đại cương</td>
            </tr>
            <tr>
                <td class="p-3">Kiến thức giáo dục thể chất và quốc phòng an ninh</td>
                <td class="p-3"><input type="number" min="1" value="0" class="p-2 border border-gray-300 rounded-lg w-full"></td>
                <td class="p-3"><input type="number" min="1" value="0" class="p-2 border border-gray-300 rounded-lg w-full"></td>
            </tr>
            <tr>
                <td class="p-3">Kiến thức ngoại ngữ</td>
                <td class="p-3"><input type="number" min="1" value="0" class="p-2 border border-gray-300 rounded-lg w-full"></td>
                <td class="p-3"><input type="number" min="1" value="0" class="p-2 border border-gray-300 rounded-lg w-full"></td>
            </tr>
            <tr>
                <td class="p-3">Kiến thức lý luận chính trị</td>
                <td class="p-3"><input type="number" min="1"  value="0" class="p-2 border border-gray-300 rounded-lg w-full"></td>
                <td class="p-3"><input type="number" min="1" value="0" class="p-2 border border-gray-300 rounded-lg w-full"></td>
            </tr>
            <tr>
                <td class="p-3">Kiến thức giáo dục đại cương khác</td>
                <td class="p-3"><input type="number" min="1" value="0" class="p-2 border border-gray-300 rounded-lg w-full"></td>
                <td class="p-3"><input type="number" min="1" value="0" class="p-2 border border-gray-300 rounded-lg w-full"></td>
            </tr>
            <tr class="hover:bg-orange-100">
                <td class="p-3" colspan="3">Khối kiến thức giáo dục chuyên nghiệp</td>
            </tr>
            <tr>
                <td class="p-3">Kiến thức cơ sở ngành</td>
                <td class="p-3"><input type="number" min="1" value="0" class="p-2 border border-gray-300 rounded-lg w-full"></td>
                <td class="p-3"><input type="number" min="1" value="0" class="p-2 border border-gray-300 rounded-lg w-full"></td>
            </tr>
            <tr>
                <td class="p-3">Kiến thức ngành</td>
                <td class="p-3"><input type="number" min="1" value="0" class="p-2 border border-gray-300 rounded-lg w-full"></td>
                <td class="p-3"><input type="number" min="1" value="0" class="p-2 border border-gray-300 rounded-lg w-full"></td>
            </tr>
            <tr>
                <td class="p-3">Kiến thức chuyên ngành</td>
                <td class="p-3"><input type="number" min="1" value="0" class="p-2 border border-gray-300 rounded-lg w-full"></td>
                <td class="p-3"><input type="number" min="1" value="0" class="p-2 border border-gray-300 rounded-lg w-full"></td>
            </tr>
            </tbody>
        </table>
        <button class="btn-green px-6 py-3 rounded-lg mt-4" id="btnAdd" >Thêm</button>
    </div>
</div>

<!-- Modal for Delete Confirmation -->
<div id="deleteModal" class="modal">
    <div class="modal-content">
            <span class="close text-2xl font-bold text-gray-500 float-right cursor-pointer"
                  onclick="closeModal('deleteModal')">×</span>
        <h2 class="text-2xl font-semibold text-gray-700 mb-4">Xác Nhận Xóa</h2>
        <p class="text-lg">Bạn có chắc chắn muốn xóa chương trình khung ngành <span id="deleteMajorName"></span>
            không?</p>
        <div class="flex gap-4 mt-4">
            <button class="btn-red px-6 py-3 rounded-lg" onclick="confirmDelete()">Xóa</button>
            <button class="btn-gray px-6 py-3 rounded-lg" onclick="closeModal('deleteModal')">Hủy</button>
        </div>
    </div>
</div>
<script th:inline="javascript">
    // Lấy thông tin quyền từ server
    const isAdmin = /*[[${isAdmin}]]*/ true; // Đặt true để test, sau đó kiểm tra server side
    const userRole = /*[[${userRole}]]*/ '';

    // Biến toàn cục để lưu trữ danh sách chương trình
    let programs = [];

    // Ẩn/hiện các nút chức năng dựa vào quyền
    function checkPermission() {
        const adminButtons = document.querySelectorAll('.btn-orange, .btn-yellow, .btn-red');
        adminButtons.forEach(button => {
            button.style.display = isAdmin ? 'inline-block' : 'none';
        });

        // Ẩn các modal không cần thiết nếu không phải admin
        if (!isAdmin) {
            const addModal = document.getElementById('addModal');
            const editModal = document.getElementById('editModal');
            const deleteModal = document.getElementById('deleteModal');
            if (addModal) addModal.style.display = 'none';
            if (editModal) editModal.style.display = 'none';
            if (deleteModal) deleteModal.style.display = 'none';
        }
    }
       async function fetchCTDaoTaoById(mactdt) {
        try {
            const response = await fetch(`/api/CTDT_View/${mactdt}`);
            if (!response.ok) {
                if (response.status === 404) throw new Error('Không tìm thấy chương trình đào tạo');
                throw new Error('Lỗi khi lấy thông tin chương trình đào tạo');
            }
            return await response.json();
        } catch (error) {
            console.error('Lỗi:', error.message);
            throw error;
        }
    }
    // Gọi danh sách chương trình đào tạo đã có chương trình khung
    async function fetchCTDTDaCoKhung() {
        try {
            const response = await fetch('/api/CTDT_View/da-co-khung');
            if (response.status === 204) {
                console.log("Không có dữ liệu CTĐT đã có khung.");
                programs = [];
                return;
            } else if (!response.ok) {
                throw new Error(`Lỗi khi gọi API /da-co-khung: ${response.statusText}`);
            }
            programs = await response.json();
            console.log("Danh sách CTĐT đã có khung (programs):", programs);

            const tableBody = document.getElementById('programTableBody');
            tableBody.innerHTML = ""; // Xóa nội dung cũ

            if (!Array.isArray(programs) || programs.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="3" class="p-4 text-center text-gray-500">Không có chương trình đào tạo nào.</td></tr>';
                return;
            }

            programs.forEach((program, index) => {
                console.log(`Rendering row ${index} (da-co-khung):`, program); // Log từng dòng dữ liệu

                // Kiểm tra dữ liệu hợp lệ
                if (!program || typeof program !== 'object' || program.maCTDT === undefined || program.tenCTDT === undefined) {
                    console.error(`Dữ liệu không hợp lệ tại index ${index} (da-co-khung):`, program);
                    return; // Bỏ qua nếu dữ liệu không hợp lệ
                }

                // Tạo hàng bảng thủ công
                const row = document.createElement("tr");
                row.className = "hover:bg-orange-100";

                // Cột MÃ CTDT
                const tdMaCtdt = document.createElement("td");
                tdMaCtdt.className = "p-4";
                tdMaCtdt.textContent = program.maCTDT !== undefined ? program.maCTDT.toString() : 'N/A';
                row.appendChild(tdMaCtdt);

                // Cột TÊN CTDT
                const tdTenCtdt = document.createElement("td");
                tdTenCtdt.className = "p-4";
                tdTenCtdt.textContent = program.tenCTDT !== undefined ? program.tenCTDT : 'N/A';
                row.appendChild(tdTenCtdt);

                // Cột THAO TÁC
                const tdActions = document.createElement("td");
                tdActions.className = "p-4 flex gap-2";
                tdActions.innerHTML = `
                    <button class="btn-green px-4 py-2 rounded-lg" onclick="viewDetails(${program.maCTDT})">Xem chi tiết</button>
                    ${isAdmin ? `
                        <button class="btn-yellow px-4 py-2 rounded-lg" onclick="editProgram(${program.maCTDT})">Sửa</button>
                    ` : ''}
                `;
                row.appendChild(tdActions);

                tableBody.appendChild(row);
            });
        } catch (error) {
            console.error("Lỗi fetchCTDTDaCoKhung:", error);
            const tableBody = document.getElementById('programTableBody');
            tableBody.innerHTML = '<tr><td colspan="3" class="p-4 text-center text-red-500">Lỗi khi tải dữ liệu.</td></tr>';
        }
    }

    // Gọi danh sách các chương trình đào tạo chưa có chương trình khung
    async function fetchCTDTChuaCoKhung() {
        try {
            const response = await fetch('/api/CTDT_View/chua-co-khung');
            if (response.status === 204) {
                console.log("Không có dữ liệu CTĐT chưa có khung.");
                return [];
            } else if (!response.ok) {
                throw new Error(`Lỗi khi gọi API /chua-co-khung: ${response.statusText}`);
            }
            const ctDaoTaoList = await response.json();
            console.log("Danh sách CTĐT chưa có khung:", ctDaoTaoList);

            const tableBody = document.getElementById('programSelectTableBody');
            tableBody.innerHTML = "";
            if (!Array.isArray(ctDaoTaoList) || ctDaoTaoList.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="3" class="p-4 text-center text-gray-500">Không còn chương trình đào tạo nào để thêm.</td></tr>';
            } else {
                ctDaoTaoList.forEach((program, index) => {

                    // Kiểm tra dữ liệu hợp lệ
                    if (!program || typeof program !== 'object' || program.maCTDT === undefined || program.tenCTDT === undefined) {
                        console.error(`Dữ liệu không hợp lệ tại index ${index} (chua-co-khung):`, program);
                        return; // Bỏ qua nếu dữ liệu không hợp lệ
                    }

                    // Tạo hàng bảng thủ công
                    const row = document.createElement("tr");
                    row.className = "hover:bg-orange-100";

                    // Cột MÃ CTDT
                    const tdMaCtdt = document.createElement("td");
                    tdMaCtdt.className = "p-3";
                    tdMaCtdt.textContent = program.maCTDT !== undefined ? program.maCTDT.toString() : 'N/A';
                    row.appendChild(tdMaCtdt);

                    // Cột TÊN CTDT
                    const tdTenCtdt = document.createElement("td");
                    tdTenCtdt.className = "p-3";
                    tdTenCtdt.textContent = program.tenCTDT !== undefined ? program.tenCTDT : 'N/A';
                    row.appendChild(tdTenCtdt);

                    // Cột Hành động
                    const tdAction = document.createElement("td");
                    tdAction.className = "p-3";
                    tdAction.innerHTML = `
                        <button class="btn-green px-4 py-2 rounded-lg" onclick="selectProgram('${program.maCTDT}', '${program.tenCTDT}')">Chọn</button>
                    `;
                    row.appendChild(tdAction);

                    tableBody.appendChild(row);
                });
            }
        } catch (error) {
            console.error("Lỗi fetchCTDTChuaCoKhung:", error);
            const tableBody = document.getElementById('programSelectTableBody');
            tableBody.innerHTML = '<tr><td colspan="3" class="p-4 text-center text-red-500">Lỗi khi tải dữ liệu.</td></tr>';
        }
    }

            // Trả về Promise chứa data
      function fetchMaxMaKhung() {
          return fetch("http://localhost:8080/api/khungchuongtrinh/maxId")
              .then(response => {
                  if (!response.ok) {
                      throw new Error("Lỗi khi gọi API");
                  }
                  return response.json();
              })
              .then(data => {
                  console.log("Max mã khung:", data);
                  return data;
              })
              .catch(error => {
                  console.error("Lỗi khi fetch maxId khung:", error);
                  throw error;
              });
      }

      function fetchMaxMaKhoiKienThuc() {
          return fetch("http://localhost:8080/api/khoikienthuc/maxId")
              .then(response => {
                  if (!response.ok) {
                      throw new Error("Lỗi khi gọi API");
                  }
                  return response.json();
              })
              .then(data => {
                  console.log("Max mã khối kiến thức:", data);
                  return data; // <-- QUAN TRỌNG
              })
              .catch(error => {
                  console.error("Lỗi khi fetch maxId khối kiến thức:", error);
                  throw error;
              });
      }
      //Lấy chương trình khung bằng mã ctdt
      async function fetchCTKhungByMaCTDT(maCTDT) {
          try {
              const response = await fetch(`/api/khungchuongtrinh/theomaCTDT/${maCTDT}`);
              if (!response.ok) {
                  throw new Error(`HTTP error! Status: ${response.status}`);
              }
              const data = await response.json();
              return data;
          } catch (error) {
              console.error("Lỗi khi gọi API CTKhung theo maCTDT:", error);
              return null;
          }
      }



      //Lấy danh sách khối kiến thức bởi mã khung
      async function fetchKhoiKienThucByMaKhung(maKhung) {
          try {
              const response = await fetch(`/api/khoikienthuc/byKhung/${maKhung}`);
              if (!response.ok) {
                  throw new Error(`Lỗi khi gọi API: ${response.status}`);
              }
              const data = await response.json();
              return data;
          } catch (error) {
              console.error("Lỗi khi lấy khối kiến thức theo maKhung:", error);
              return null;
          }
      }




      // Biến lưu trữ dữ liệu toàn cục sau khi gọi selectProgram
      let newMaKhungGlobal = null;
      let list_newKhoiKienThucGlobal = [];

      async function selectProgram(maCTDT, tenCTDT) {
            document.getElementById("selectProgramModal").style.display = "none";
            document.getElementById("addModal").style.display = "block";
            document.getElementById("selectedProgramInfo").innerHTML = `
                  <p class="text-lg font-medium text-gray-700">
                        Chương trình: ${tenCTDT} mã (${maCTDT})
                  </p>
            `;

            try {
                  const maxMaKhung = parseInt(await fetchMaxMaKhung(), 10) || 0;
                  const newMaKhung = maxMaKhung + 1;

                  const maxMaKhoiKienThuc = parseInt(await fetchMaxMaKhoiKienThuc(), 10) || 0;
                  let nextMaKhoi = maxMaKhoiKienThuc + 1;

                  const rows = document.querySelectorAll("#addTableBody tr");
                  rows.forEach((row) => {
                        const inputs = row.querySelectorAll("input");
                        if (inputs.length === 2) {
                              inputs.forEach(input => {
                                    input.setAttribute("data-khoikienthuc", nextMaKhoi);
                              });
                              nextMaKhoi++;
                        }
                  });
                    // Gán vào biến toàn cục để btnAdd dùng được
                    const ctDaoTao = await fetchCTDaoTaoById(maCTDT);
                    newMaKhungGlobal = {
                        makhung: newMaKhung,
                        mactdt: maCTDT
                    };
                  const allInputs = document.querySelectorAll("#addTableBody input");
                  const list_newKhoiKienThuc = [];
                  for (let i = 0; i < allInputs.length; i += 2) {
                        const inpBB = allInputs[i];
                        const inpTC = allInputs[i + 1];
                        const makhoikienthuc = parseInt(inpBB.dataset.khoikienthuc, 10);

                        list_newKhoiKienThuc.push({
                              makhung: newMaKhung,
                              makhoikienthuc: makhoikienthuc,
                              tinbatbuoc: parseInt(inpBB.value, 10) || 0,
                              tintuchon: parseInt(inpTC.value, 10) || 0
                        });
                  }


                  list_newKhoiKienThucGlobal = list_newKhoiKienThuc;

                  console.log("Khởi tạo ban đầu:");
                  console.log("newMaKhung:", newMaKhungGlobal);
                  console.log("list_newKhoiKienThuc:", list_newKhoiKienThucGlobal);

            } catch (error) {
                  console.error("Lỗi khi xử lý selectProgram:", error);
            }
      }
        async function addCTKhung(maCTDT, maKhung) {
            try {
                const response = await fetch(`http://localhost:8080/api/khungchuongtrinh?maCTDT=${maCTDT}&maKhung=${maKhung}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const result = await response.text();

                if (response.ok) {
                    return { success: true, message: result };
                } else {
                    return { success: false, message: result || 'Đã xảy ra lỗi khi thêm CTKhung.' };
                }
            } catch (error) {
                return { success: false, message: 'Lỗi kết nối: ' + error.message };
            }
        }
        async function addKhoiKienThuc(maKhoiKienThuc, maKhung, tinChiBatBuoc, tinChiTuChon) {
            try {
                const params = new URLSearchParams({
                    maKhoiKienThuc: maKhoiKienThuc,
                    maKhung: maKhung,
                    tinChiBatBuoc: tinChiBatBuoc,
                    tinChiTuChon: tinChiTuChon
                });

                const response = await fetch(`http://localhost:8080/api/khoikienthuc?${params.toString()}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded', // hoặc có thể không cần header này
                    }
                });

                const text = await response.text();
                if (response.ok) {
                    return { success: true, message: text };
                } else {
                    return { success: false, message: text };
                }
            } catch (error) {
                return { success: false, message: 'Lỗi kết nối: ' + error.message };
            }
        }

        document.getElementById("btnAdd").addEventListener("click", async () => {
            if (!list_newKhoiKienThucGlobal || list_newKhoiKienThucGlobal.length === 0) {
                console.warn("Chưa chọn chương trình đào tạo!");
                alert("Vui lòng chọn chương trình đào tạo trước!");
                return;
            }

            // Update list_newKhoiKienThucGlobal with input values
            const allInputs = document.querySelectorAll("#addTableBody input");
            for (let i = 0; i < allInputs.length; i += 2) {
                const inpBB = allInputs[i];
                const inpTC = allInputs[i + 1];
                const makhoikienthuc = parseInt(inpBB.dataset.khoikienthuc, 10);

                const item = list_newKhoiKienThucGlobal.find(x => x.makhoikienthuc === makhoikienthuc);
                if (item) {
                    item.tinbatbuoc = parseInt(inpBB.value, 10) || 0;
                    item.tintuchon = parseInt(inpTC.value, 10) || 0;
                }
            }

            console.log("✅ Dữ liệu sau khi cập nhật từ input:");
            console.log("newMaKhung:", newMaKhungGlobal);
            console.log("list_newKhoiKienThuc:", list_newKhoiKienThucGlobal);

            try {
                // Add CTKhung first
                const ctKhungResult = await addCTKhung(newMaKhungGlobal.mactdt, newMaKhungGlobal.makhung);
                if (!ctKhungResult.success) {
                    console.error("Lỗi khi thêm CTKhung:", ctKhungResult.message);
                    alert(`Tạo chương trình khung thất bại: ${ctKhungResult.message}`);
                    return;
                }
                console.log("Thêm CTKhung thành công:", ctKhungResult.message);

                // Add all KhoiKienThuc entries
                const khoiKienThucPromises = list_newKhoiKienThucGlobal.map(item =>
                    addKhoiKienThuc(
                        item.makhoikienthuc,
                        item.makhung,
                        item.tinbatbuoc,
                        item.tintuchon
                    )
                );

                const khoiKienThucResults = await Promise.all(khoiKienThucPromises);

                // Check if all KhoiKienThuc calls were successful
                const allSuccessful = khoiKienThucResults.every(result => result.success);
                if (allSuccessful) {
                    alert("Tạo chương trình khung và khối kiến thức thành công!");
                } else {
                    const errorMessages = khoiKienThucResults
                        .filter(result => !result.success)
                        .map(result => result.message)
                        .join("; ");
                    console.error("Lỗi khi thêm một hoặc nhiều khối kiến thức:", errorMessages);
                    alert(`Tạo chương trình khung thành công, nhưng lỗi khi thêm khối kiến thức: ${errorMessages}`);
                    closeModal(addModal);
                }

                // Reset inputs and global variables
                allInputs.forEach(input => {
                    input.value = 0;
                });
                newMaKhungGlobal = null;
                list_newKhoiKienThucGlobal = [];
                console.log("Đã reset xong input và biến toàn cục.");
            } catch (error) {
                console.error("Lỗi trong quá trình thêm chương trình khung hoặc khối kiến thức:", error);
                alert(`Lỗi: ${error.message}`);
            }
        });

    // Load programs on page load
    async function loadPrograms() {
        await fetchCTDTDaCoKhung();
    }

    // Open modal to select program
    function openSelectProgramModal() {
        fetchCTDTChuaCoKhung();
        document.getElementById("selectProgramModal").style.display = "block";
    }


    // Hiển thị xem chi tiết
    function viewDetails(index) {
        alert(`Bạn muốn xem chi tiết chương trình khung của CTDT có mã -${index}`);
        renderDataToDetailModal(index)
        document.getElementById("viewModal").style.display = "block";
    }

    // Edit program
    function editProgram(index) {
        alert(`Bạn muốn xem chi tiết chương trình khung của CTDT có mã -${index}`);
        renderDataToEditModal(index);
        document.getElementById("editModal").style.display = "block";
    }

  async function renderDataToDetailModal(maCTDT) {
      const ctKhungList = await fetchCTKhungByMaCTDT(maCTDT);

      if (ctKhungList && ctKhungList.length === 1) {
          const maKhung = ctKhungList[0].maKhung;
          const khoiKTList = await fetchKhoiKienThucByMaKhung(maKhung);

          console.log("CTKhung List:", ctKhungList);
          console.log("Khối Kiến Thức List:", khoiKTList);

          const allInputs = document.querySelectorAll("#detailTableBody input");

          for (let i = 0; i < allInputs.length; i += 2) {
              const inpBB = allInputs[i];
              const inpTC = allInputs[i + 1];
              const index = i / 2;

              if (khoiKTList[index]) {
                  inpBB.value = parseInt(khoiKTList[index].tinChiBatBuoc, 10) || 0;
                  inpTC.value = parseInt(khoiKTList[index].tinChiTuChon, 10) || 0;
                  // Vô hiệu hóa input để chỉ cho xem
                  inpBB.disabled = true;
                  inpTC.disabled = true;
              }
          }
      } else {
          console.log("Không lấy được dữ liệu hoặc có nhiều hơn một khung chương trình.");
      }
  }
  // Biến lưu trữ dữ liệu toàn cục
  let ctKhungList = null;
  let khoiKTList = [];

  async function renderDataToEditModal(maCTDT) {
      ctKhungList = await fetchCTKhungByMaCTDT(maCTDT);

      if (ctKhungList && ctKhungList.length === 1) {
          const maKhung = ctKhungList[0].maKhung;
          khoiKTList = await fetchKhoiKienThucByMaKhung(maKhung);

          console.log("CTKhung List:", ctKhungList);
          console.log("Khối Kiến Thức List:", khoiKTList);

          const rows = document.querySelectorAll("#editTableBody tr");
          let index = 0;
          rows.forEach((row) => {
              const inputs = row.querySelectorAll("input");
              if (inputs.length === 2 && khoiKTList[index]) {
                  const { maKhoiKienThuc, tinChiBatBuoc, tinChiTuChon } = khoiKTList[index];

                  // Gán data attribute để lưu mã khối kiến thức
                  inputs[0].setAttribute("data-khoikienthuc", maKhoiKienThuc);
                  inputs[1].setAttribute("data-khoikienthuc", maKhoiKienThuc);

                  // Gán giá trị tín chỉ vào input
                  inputs[0].value = parseInt(tinChiBatBuoc, 10) || 0;
                  inputs[1].value = parseInt(tinChiTuChon, 10) || 0;

                  index++;
              }
          });
      } else {
          console.warn("Không lấy được dữ liệu hoặc có nhiều hơn một khung chương trình.");
      }
  }

        async function updateKhoiKienThuc(maKhoiKienThuc, tinChiBatBuoc, tinChiTuChon) {
            try {
                const response = await fetch(`http://localhost:8080/api/khoikienthuc/${maKhoiKienThuc}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        tinChiBatBuoc,
                        tinChiTuChon
                    })
                });

                const result = await response.text();
                return response.ok
                    ? { success: true, message: result }
                    : { success: false, message: result || 'Lỗi khi cập nhật KhoiKienThuc' };
            } catch (error) {
                return { success: false, message: 'LWỗi kết nối: ' + error.message };
            }
        }
        document.getElementById("btnEdit").addEventListener("click", async () => {
            if (!khoiKTList || khoiKTList.length === 0) {
                console.warn("⚠️ Vui lòng chọn chương trình đào tạo trước!");
                alert("Vui lòng chọn chương trình đào tạo trước!");
                return;
            }

            // Update khoiKTList with input values
            const allInputs = document.querySelectorAll("#editTableBody input");
            for (let i = 0; i < allInputs.length; i += 2) {
                const inpBB = allInputs[i];
                const inpTC = allInputs[i + 1];
                const maKhoiKienThuc = parseInt(inpBB.dataset.khoikienthuc, 10);

                const khoi = khoiKTList.find(k => k.maKhoiKienThuc === maKhoiKienThuc);
                if (khoi) {
                    khoi.tinChiBatBuoc = parseInt(inpBB.value, 10) || 0;
                    khoi.tinChiTuChon = parseInt(inpTC.value, 10) || 0;
                }
            }

            console.log("✅ Dữ liệu sau khi cập nhật từ input:");
            console.log("Chương trình khung:", ctKhungList);
            console.log("Danh sách khối kiến thức sau cập nhật:", khoiKTList);

            try {
                // Update all KhoiKienThuc entries
                const updatePromises = khoiKTList.map(khoi =>
                    updateKhoiKienThuc(
                        khoi.maKhoiKienThuc,
                        khoi.tinChiBatBuoc,
                        khoi.tinChiTuChon
                    )
                );

                const updateResults = await Promise.all(updatePromises);

                // Check if all updates were successful
                const allSuccessful = updateResults.every(result => result.success);
                if (allSuccessful) {
                    alert("Cập nhật khối kiến thức thành công!");
                } else {
                    const errorMessages = updateResults
                        .filter(result => !result.success)
                        .map(result => result.message)
                        .join("; ");
                    console.error("Lỗi khi cập nhật một hoặc nhiều khối kiến thức:", errorMessages);
                    alert(`Lỗi khi cập nhật khối kiến thức: ${errorMessages}`);
                    return;
                }

                // Reset inputs and global variables only on success
                allInputs.forEach(input => {
                    input.value = 0;
                });
                ctKhungList = null;
                khoiKTList = [];
                console.log("🔄 Đã reset input và biến toàn cục.");

            } catch (error) {
                console.error("Lỗi trong quá trình cập nhật khối kiến thức:", error);
                alert(`Lỗi: ${error.message}`);
            }
        });


    // Delete program
    function openDeleteModal(index) {
         alert(`Bạn muốn xem chi tiết chương trình khung của CTDT có mã:${index}`);
        document.getElementById("deleteMajorName").textContent = index|| "Không xác định";
        document.getElementById("deleteModal").style.display = "block";
    }

    function confirmDelete() {
        alert("Chức năng xóa chưa được triển khai hoàn chỉnh. Vui lòng cung cấp API xóa chương trình.");
        closeModal("deleteModal");
    }


    // Đóng các modal
    function closeModal(modalId) {
        document.getElementById(modalId).style.display = "none";
        if (modalId === "addModal") {
            selectedProgram = null;
            document.getElementById("selectedProgramInfo").innerHTML = "";
        }
    }

    // Gọi hàm kiểm tra quyền và load programs khi trang load
    window.onload = async function () {
        checkPermission();
        await loadPrograms();
    };
</script>

</body>

</html>